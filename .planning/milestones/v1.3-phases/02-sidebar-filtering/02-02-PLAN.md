---
phase: 02-sidebar-filtering
plan: "02"
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - content-script.js
autonomous: false
requirements: [FILT-01, FILT-02, FILT-03]

must_haves:
  truths:
    - "When user watches a video, sidebar suggestions from other categories are collapsed"
    - "When user navigates to a different video via SPA navigation, the sidebar re-filters for the new video's category"
    - "Double-filtering on the same navigation is prevented (no duplicate API calls)"
    - "On each navigation, previously collapsed items from the old video are restored before re-filtering"
  artifacts:
    - path: "content-script.js"
      provides: "Updated YT_NAVIGATION handler calling initForVideo()"
      contains: "initForVideo(message.videoId)"
    - path: "content-script.js"
      provides: "Updated yt-navigate-finish handler with deduplication"
      contains: "lastProcessedVideoId"
  key_links:
    - from: "service-worker.js YT_NAVIGATION message"
      to: "content-script.js YT_NAVIGATION handler"
      via: "chrome.runtime.onMessage.addListener"
      pattern: "message\\.type === 'YT_NAVIGATION'"
    - from: "content-script.js YT_NAVIGATION handler"
      to: "initForVideo()"
      via: "direct async call after teardown"
      pattern: "initForVideo.*message\\.videoId"
    - from: "content-script.js initial load"
      to: "initForVideo()"
      via: "module-level call with initialVideoId"
      pattern: "initForVideo.*initialVideoId"
---

<objective>
Wire the filtering engine from Plan 01 into the navigation lifecycle. Update the two navigation handlers (YT_NAVIGATION message listener and yt-navigate-finish DOM event) to: (1) teardown previous video state, (2) call initForVideo(). Add deduplication to prevent double-filtering when both signals fire for the same navigation. Replace the existing module-level fetchAndLogCategory() call with initForVideo(). Verify the full end-to-end filtering flow in the browser.

Purpose: Makes filtering actually run on every navigation. Without this wiring, the engine from Plan 01 is never invoked.

Output: Fully wired content-script.js where every video navigation triggers the complete filter-and-observe cycle. Human verification confirms off-topic sidebar items collapse in the real browser.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-sidebar-filtering/02-RESEARCH.md
@.planning/phases/02-sidebar-filtering/02-01-SUMMARY.md
@content-script.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire navigation handlers to initForVideo() with deduplication</name>
  <files>content-script.js</files>
  <action>
Make the following targeted changes to content-script.js. Do NOT rewrite the file — make surgical edits to the existing navigation sections.

**1. Add deduplication variable** (add near the other module-level state variables from Plan 01):
```javascript
let lastProcessedVideoId = null; // prevents double-filtering when both nav signals fire
```

**2. Replace the existing YT_NAVIGATION message handler** (currently calls `fetchAndLogCategory`):
```javascript
chrome.runtime.onMessage.addListener((message) => {
  if (message.type === 'YT_NAVIGATION') {
    if (message.videoId === lastProcessedVideoId) return; // deduplicate
    lastProcessedVideoId = message.videoId;

    // Teardown previous video state
    resetAllCollapsed();
    disconnectSidebarObserver();
    sessionCategoryCache.clear();
    currentCategoryId = null;

    // Initialize filtering for new video
    initForVideo(message.videoId);
  }
});
```

**3. Replace the existing yt-navigate-finish handler** (currently calls `fetchAndLogCategory`):
```javascript
document.addEventListener('yt-navigate-finish', () => {
  const videoId = new URL(window.location.href).searchParams.get('v');
  if (!videoId || videoId === lastProcessedVideoId) return; // deduplicate
  lastProcessedVideoId = videoId;

  // Teardown previous video state
  resetAllCollapsed();
  disconnectSidebarObserver();
  sessionCategoryCache.clear();
  currentCategoryId = null;

  // Initialize filtering for new video
  initForVideo(videoId);
});
```

**4. Replace the existing module-level initial load** (currently calls `fetchAndLogCategory(initialVideoId)`):
```javascript
// ─── Initial Load ─────────────────────────────────────────────────────────────
const initialVideoId = new URL(window.location.href).searchParams.get('v');
if (initialVideoId) {
  lastProcessedVideoId = initialVideoId;
  initForVideo(initialVideoId);
}
```

**Key constraints:**
- `fetchAndLogCategory` function body must remain in the file (do not delete it — avoids risk of breaking something). Remove all call sites but keep the function definition.
- The teardown order is: resetAllCollapsed() then disconnectSidebarObserver() then sessionCategoryCache.clear() then currentCategoryId = null then lastProcessedVideoId = newVideoId then initForVideo(newVideoId).
- Do NOT call both `initForVideo` and `fetchAndLogCategory` for the same navigation — use initForVideo only.
  </action>
  <verify>
    <automated>node -e "
const fs = require('fs');
const src = fs.readFileSync('/home/solanoe/code/tfy/content-script.js', 'utf8');
const checks = [
  ['lastProcessedVideoId variable', src.includes('let lastProcessedVideoId = null')],
  ['YT_NAVIGATION calls initForVideo', src.includes('initForVideo(message.videoId)')],
  ['YT_NAVIGATION deduplication check', src.includes('message.videoId === lastProcessedVideoId')],
  ['YT_NAVIGATION calls resetAllCollapsed', /YT_NAVIGATION[\s\S]{0,300}resetAllCollapsed/.test(src)],
  ['YT_NAVIGATION clears sessionCategoryCache', /YT_NAVIGATION[\s\S]{0,300}sessionCategoryCache\.clear/.test(src)],
  ['yt-navigate-finish calls initForVideo', /yt-navigate-finish[\s\S]{0,500}initForVideo/.test(src)],
  ['yt-navigate-finish deduplication check', /yt-navigate-finish[\s\S]{0,500}lastProcessedVideoId/.test(src)],
  ['initial load calls initForVideo', /initialVideoId[\s\S]{0,200}initForVideo/.test(src)],
  ['fetchAndLogCategory function still defined', src.includes('async function fetchAndLogCategory(')],
];
checks.forEach(([name, ok]) => console.log((ok ? 'PASS' : 'FAIL') + ': ' + name));
process.exit(checks.every(([,ok]) => ok) ? 0 : 1);
"
    </automated>
    <manual>Load the extension in Chrome (chrome://extensions, developer mode, load unpacked). Navigate to a YouTube watch page. Confirm console shows [TFY] log lines. No JavaScript errors in the console.</manual>
  </verify>
  <done>All 9 checks pass. Navigation handlers call initForVideo() with proper teardown and deduplication. Both YT_NAVIGATION and yt-navigate-finish are wired. Initial load uses initForVideo().</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verify end-to-end sidebar filtering in Chrome</name>
  <action>Human verification of complete Phase 2 sidebar filtering. All automated tasks in this plan and Plan 01 are already complete. Verify the visual result in the browser.</action>
  <verify>
    <manual>
      1. Open Chrome, go to chrome://extensions, reload the TFY extension after content-script.js changes.
      2. Navigate to any YouTube watch page (e.g., a Science and Technology video like a coding tutorial).
      3. Open DevTools Console. Confirm you see:
         - [TFY] Detected video: (videoId)
         - [TFY] Current video category: (number)
         - [TFY] Sidebar filter: collapsed N of M suggestions
      4. Look at the sidebar — suggestions from OTHER categories should appear collapsed to a thin row with "hidden: off-topic" text visible. Same-category suggestions appear normally.
      5. Click a different YouTube video (SPA navigation). Confirm:
         - Console shows new category detection lines
         - Old collapsed items un-collapse (sidebar resets)
         - New off-topic items for the new video are collapsed
      6. Scroll down the sidebar on a long-watched video. Confirm newly-loaded sidebar items are also filtered (not just the initial set).
      7. Right-click a collapsed item and Inspect. Confirm the ytd-compact-video-renderer element has class tfy-hidden and is still in the DOM (not removed). Confirm the style#tfy-styles tag exists in head.
    </manual>
  </verify>
  <done>Human confirms: off-topic sidebar items are visually collapsed with "hidden: off-topic" label, same-category items are visible, SPA navigation re-filters, lazy items are filtered, DOM elements remain (not removed).</done>
  <what-built>
    Complete Phase 2 sidebar filtering implementation:
    - CSS collapse styles injected: off-topic items show at 20px height with "hidden: off-topic" label
    - filterSidebar() fetches sidebar video categories in a single batched API call
    - MutationObserver watches #secondary for lazily-added sidebar items
    - initForVideo() sequences: current video category, initial filter, arm observer
    - Navigation handlers (YT_NAVIGATION + yt-navigate-finish) tear down and re-initialize on every video change
    - Session cache prevents duplicate API calls within a watch session
    - Deduplication variable prevents double-filtering when both nav signals fire
  </what-built>
  <how-to-verify>Follow the 7 steps in the verify section above.</how-to-verify>
  <resume-signal>Type "approved" if all 7 steps pass, or describe what failed (e.g., "no items collapsed — console shows category fetch failed")</resume-signal>
</task>

</tasks>

<verification>
After Task 1 automated check passes and human checkpoint is approved:

```bash
node -e "
const fs = require('fs');
const src = fs.readFileSync('/home/solanoe/code/tfy/content-script.js', 'utf8');
console.log('File size:', src.length, 'bytes');
console.log('Functions present:');
['injectTFYStyles','extractVideoIdFromRenderer','collapseElement','resetAllCollapsed',
 'filterSidebar','observeSidebar','disconnectSidebarObserver','initForVideo','fetchAndLogCategory']
 .forEach(fn => console.log('  ' + (src.includes(fn) ? 'YES' : 'NO') + ': ' + fn));
"
```

All 9 functions must be present.
</verification>

<success_criteria>
- Navigation to a YouTube watch page triggers sidebar filtering within ~1 second of load
- Off-topic sidebar suggestions are collapsed to a "hidden: off-topic" label (visibly present)
- Same-category suggestions are not collapsed
- SPA navigation resets old collapsed items and re-filters for the new video
- Lazily-loaded sidebar items (via scroll) are also filtered
- No JavaScript errors in browser DevTools console
- Human verification approved (all 7 steps pass)
</success_criteria>

<output>
After completion, create `.planning/phases/02-sidebar-filtering/02-02-SUMMARY.md`
</output>
