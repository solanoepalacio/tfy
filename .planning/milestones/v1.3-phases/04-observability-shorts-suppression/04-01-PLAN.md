---
phase: 04-observability-shorts-suppression
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - content-script.js
autonomous: true
requirements:
  - LABL-01
  - SHRT-01

must_haves:
  truths:
    - "Collapsed sidebar items display a label like 'hidden: Gaming · How to speedrun Minecraft' — not just 'hidden: off-topic'"
    - "The Shorts shelf panel is not visible on any YouTube watch page sidebar, regardless of filtering state"
    - "Labels reflect actual video title and category name (not IDs) for every collapsed item"
  artifacts:
    - path: "content-script.js"
      provides: "CSS rule using data-tfy-label attribute on ::before, Shorts shelf hide rule, category ID→name lookup table, updated collapseElement, updated filterSidebar"
      contains: "CATEGORY_NAMES"
  key_links:
    - from: "filterSidebar()"
      to: "collapseElement(el, title, categoryName)"
      via: "title extracted from DOM anchor text, categoryName from CATEGORY_NAMES lookup"
      pattern: "collapseElement\\(el,"
    - from: "injectTFYStyles()"
      to: "data-tfy-label attribute on yt-lockup-view-model.tfy-hidden"
      via: "CSS attr() function in ::before content"
      pattern: "attr\\(data-tfy-label\\)"
    - from: "injectTFYStyles()"
      to: "ytd-reel-shelf-renderer, ytm-shorts-lockup-view-model-v2"
      via: "display:none CSS rule"
      pattern: "ytd-reel-shelf-renderer"
---

<objective>
Implement rich collapsed-item labels (LABL-01) and unconditional Shorts shelf suppression (SHRT-01) — both pure content-script changes requiring no new messages or storage.

Purpose: Users can see exactly what is being filtered (title + category) and are no longer distracted by the Shorts shelf in the sidebar.
Output: Updated content-script.js with CATEGORY_NAMES lookup table, data-tfy-label attribute on collapsed items, and Shorts shelf hidden via CSS.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@content-script.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CATEGORY_NAMES lookup table and update collapseElement to set data-tfy-label</name>
  <files>content-script.js</files>
  <action>
Make three targeted changes to content-script.js:

**1. Add CATEGORY_NAMES constant** after the module-level variable block (after `let filteringEnabled = true;`). Use the standard YouTube Data API v3 video category IDs. Include all categories returned by the API (use the complete list below):

```js
const CATEGORY_NAMES = {
  '1': 'Film & Animation',
  '2': 'Autos & Vehicles',
  '10': 'Music',
  '15': 'Pets & Animals',
  '17': 'Sports',
  '18': 'Short Movies',
  '19': 'Travel & Events',
  '20': 'Gaming',
  '21': 'Videoblogging',
  '22': 'People & Blogs',
  '23': 'Comedy',
  '24': 'Entertainment',
  '25': 'News & Politics',
  '26': 'Howto & Style',
  '27': 'Education',
  '28': 'Science & Technology',
  '29': 'Nonprofits & Activism',
  '30': 'Movies',
  '31': 'Anime/Animation',
  '32': 'Action/Adventure',
  '33': 'Classics',
  '34': 'Comedy',
  '35': 'Documentary',
  '36': 'Drama',
  '37': 'Family',
  '38': 'Foreign',
  '39': 'Horror',
  '40': 'Sci-Fi/Fantasy',
  '41': 'Thriller',
  '42': 'Shorts',
  '43': 'Shows',
  '44': 'Trailers',
};
```

**2. Update `collapseElement` function** to accept title and categoryName parameters and set a `data-tfy-label` attribute:

Change the current:
```js
function collapseElement(el) {
  el.classList.add('tfy-hidden');
}
```

To:
```js
function collapseElement(el, title, categoryName) {
  const label = (title && categoryName)
    ? `hidden: ${categoryName} · ${title}`
    : 'hidden: off-topic';
  el.setAttribute('data-tfy-label', label);
  el.classList.add('tfy-hidden');
}
```

**3. Extract title from renderer DOM in filterSidebar()** — pass title and categoryName to collapseElement. In the `for (const [id, el] of idToRenderer.entries())` loop, before calling collapseElement, extract the title:

Change:
```js
if (cat !== undefined && cat !== currentCategoryId) {
  collapseElement(el);
  collapsed++;
}
```

To:
```js
if (cat !== undefined && cat !== currentCategoryId) {
  const titleEl = el.querySelector('a[href*="watch?v="]');
  const title = titleEl ? titleEl.getAttribute('aria-label') || titleEl.textContent.trim() : '';
  const categoryName = CATEGORY_NAMES[cat] || cat;
  collapseElement(el, title, categoryName);
  collapsed++;
}
```

Note: YouTube's `yt-lockup-view-model` anchor elements often have an `aria-label` containing the video title. `textContent` is the fallback. Keep both to maximise coverage. If both are empty the label gracefully falls back to `'hidden: off-topic'` via the collapseElement guard.
  </action>
  <verify>
    <automated>node -e "const fs=require('fs'); const src=fs.readFileSync('content-script.js','utf8'); const checks=['CATEGORY_NAMES','data-tfy-label','aria-label','categoryName','collapseElement(el, title, categoryName)']; const failed=checks.filter(c=>!src.includes(c)); if(failed.length){console.error('MISSING:',failed);process.exit(1);}else{console.log('All checks pass');}"</automated>
    <manual>Open content-script.js and confirm: (1) CATEGORY_NAMES const exists with at least 20 entries, (2) collapseElement accepts 3 params and calls setAttribute('data-tfy-label', ...), (3) filterSidebar loop extracts title via aria-label/textContent before calling collapseElement.</manual>
  </verify>
  <done>content-script.js contains CATEGORY_NAMES lookup table, collapseElement sets data-tfy-label on the element, and filterSidebar passes title and categoryName to collapseElement.</done>
</task>

<task type="auto">
  <name>Task 2: Update CSS to use data-tfy-label and add Shorts shelf suppression rule</name>
  <files>content-script.js</files>
  <action>
Make two targeted changes to the `injectTFYStyles()` function's CSS string:

**1. Update the `::before` rule** to use the `data-tfy-label` attribute via CSS `attr()` instead of the hardcoded string 'hidden: off-topic':

Change:
```css
yt-lockup-view-model.tfy-hidden::before {
  content: 'hidden: off-topic';
  display: block;
  font-size: 11px;
  color: #888;
  padding: 2px 8px;
  line-height: 16px;
}
```

To:
```css
yt-lockup-view-model.tfy-hidden::before {
  content: attr(data-tfy-label);
  display: block;
  font-size: 11px;
  color: #888;
  padding: 2px 8px;
  line-height: 16px;
}
```

**2. Add Shorts shelf suppression rule** as a new block appended to the same CSS string. Add after the `::before` rule:

```css
/* SHRT-01: Hide Shorts shelf on watch pages */
ytd-reel-shelf-renderer,
ytm-shorts-lockup-view-model-v2 {
  display: none !important;
}
```

The `ytd-reel-shelf-renderer` selector targets the Shorts shelf container in the desktop sidebar (the shelf wrapping multiple `ytm-shorts-lockup-view-model-v2` items). Including both selectors ensures coverage whether YouTube renders individual items or the shelf wrapper first.

IMPORTANT: Do not change any other part of the CSS. The 20px max-height on `.tfy-hidden` must remain unchanged (it keeps the ::before label visible at the collapsed height — existing decision from Phase 2).
  </action>
  <verify>
    <automated>node -e "const fs=require('fs'); const src=fs.readFileSync('content-script.js','utf8'); const checks=['attr(data-tfy-label)','ytd-reel-shelf-renderer','ytm-shorts-lockup-view-model-v2','display: none !important']; const failed=checks.filter(c=>!src.includes(c)); if(failed.length){console.error('MISSING:',failed);process.exit(1);}else{console.log('All CSS checks pass');}"</automated>
    <manual>Open content-script.js, find injectTFYStyles(). Confirm: (1) ::before uses attr(data-tfy-label), (2) ytd-reel-shelf-renderer and ytm-shorts-lockup-view-model-v2 have display:none !important, (3) max-height:20px on .tfy-hidden is still present.</manual>
  </verify>
  <done>CSS uses attr(data-tfy-label) for collapsed label text. Shorts shelf selectors are hidden with display:none !important. Existing 20px max-height rule unchanged.</done>
</task>

</tasks>

<verification>
After both tasks:

```bash
node -e "
const fs = require('fs');
const src = fs.readFileSync('content-script.js', 'utf8');
const required = [
  'CATEGORY_NAMES',
  'data-tfy-label',
  'attr(data-tfy-label)',
  'ytd-reel-shelf-renderer',
  'ytm-shorts-lockup-view-model-v2',
  'display: none !important',
  'collapseElement(el, title, categoryName)',
  'aria-label',
  'max-height: 20px',
];
const failed = required.filter(c => !src.includes(c));
if (failed.length) { console.error('FAILED:', failed); process.exit(1); }
console.log('All verification checks pass');
"
```
</verification>

<success_criteria>
- CATEGORY_NAMES const maps YouTube category IDs to human-readable names
- collapseElement(el, title, categoryName) sets data-tfy-label attribute with format "hidden: {categoryName} · {title}"
- filterSidebar() extracts title from aria-label/textContent and passes to collapseElement with resolved categoryName
- CSS ::before uses attr(data-tfy-label) for label text
- ytd-reel-shelf-renderer and ytm-shorts-lockup-view-model-v2 are hidden via display:none !important in injected CSS
- All existing Phase 1-3 behaviors preserved (20px collapse height, toggle handler, navigation deduplication)
</success_criteria>

<output>
After completion, create `.planning/phases/04-observability-shorts-suppression/04-01-SUMMARY.md`
</output>
