---
phase: 06-spa-navigation-fix
plan: 02
type: execute
wave: 2
depends_on:
  - "06-01"
files_modified: []
autonomous: false
requirements:
  - SPAV-01
  - SPAV-02

must_haves:
  truths:
    - "Filtering activates when user navigates from youtube.com homepage to a watch page without a full page reload"
    - "Filtering activates when user clicks a related video in the sidebar without a full page reload"
    - "Filtering activates when user uses browser back/forward between watch pages"
    - "Exactly one [TFY] Current video category log line appears per navigation (no duplicate observers)"
  artifacts:
    - path: "manifest.json"
      provides: "Expanded match pattern verified in Chrome"
      contains: "https://www.youtube.com/*"
    - path: "content-script.js"
      provides: "Hardened observer teardown verified in Chrome console"
      contains: "sidebarObserverRetryTimer"
  key_links:
    - from: "youtube.com (homepage)"
      to: "youtube.com/watch?v=..."
      via: "SPA pushState navigation — YT_NAVIGATION relay reaches content script"
      pattern: "YT_NAVIGATION message received by content script on homepage tab"
---

<objective>
Human verification that the SPA navigation fix works correctly in a real Chrome browser — filtering activates from the homepage, from related video clicks, and from back/forward navigation.

Purpose: Chrome extension behavior cannot be verified by unit tests. The content script injection, the service worker relay, and the SPA navigation handling must be confirmed in a live browser session.

Output: Human confirms all five test scenarios pass.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-spa-navigation-fix/06-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Human Verify: SPA navigation fix in real Chrome browser</name>
  <action>
    This is a human verification checkpoint. No automated implementation required — code changes were completed in plan 06-01. The executor should present the verification steps below to the user and wait for confirmation before proceeding.
  </action>
  <verify>
    <manual>
      Before starting: open Chrome DevTools console on a YouTube tab (F12 > Console). Filter by "[TFY]" to see only extension logs.

      Reload the extension first:
      1. Go to chrome://extensions
      2. Find TFY - Topic Focused YouTube
      3. Click the reload button (circular arrow)

      Test 1 - Homepage to watch page (SPAV-01):
      1. Navigate to youtube.com (homepage) - NOT a watch URL
      2. Open DevTools console, confirm NO [TFY] logs appear (content script injected but IIFE exits because no video ID)
      3. Click any video from the homepage recommendations
      4. Watch the console - you should see exactly ONE "[TFY] Current video category: XX (CategoryName)" log line
      5. Sidebar off-topic videos should collapse within 1-2 seconds

      Test 2 - Related video click (SPAV-02):
      1. While already on a watch page, click a related video in the sidebar
      2. Watch the console - you should see exactly ONE new "[TFY] Current video category:" log line for the new video
      3. Sidebar collapses for the new video's category
      4. Confirm no duplicate "[TFY] Current video category:" lines appear for the same video

      Test 3 - Back/forward navigation (SPAV-02):
      1. Use browser back button to return to the previous video
      2. Confirm exactly ONE "[TFY] Current video category:" log line for the previous video
      3. Use browser forward button to return to the second video
      4. Confirm exactly ONE "[TFY] Current video category:" log line again

      Test 4 - Homepage Shorts shelf (regression check):
      1. Navigate to youtube.com (homepage)
      2. Confirm the Shorts shelf IS visible on the homepage (injectTFYStyles should not run on the homepage after the CSS guard fix)
      3. Navigate to a watch page
      4. Confirm the Shorts shelf in the watch page sidebar IS hidden

      Test 5 - Rapid navigation (stress test):
      1. While on a watch page, quickly click 3-4 related videos in succession without waiting for filtering to complete
      2. After settling on the final video, confirm only ONE "[TFY] Current video category:" log line appears for that final video (not multiple)
    </manual>
    <automated>MISSING - Chrome extension integration cannot be verified by automated tests. Human verification in a real Chrome browser is required.</automated>
  </verify>
  <done>Human types "approved" confirming all 5 tests pass: homepage-to-watch filtering activates, related video click filtering activates, back/forward filtering activates, Shorts shelf visible on homepage, rapid navigation produces single log line per final video.</done>
  <what-built>
    Manifest match pattern expanded to youtube.com/*, content-script.js hardened with:
    - Timer-aware observer teardown (sidebarObserverRetryTimer)
    - Idempotent initForVideo (disconnectSidebarObserver as first line)
    - Watch-page-only CSS injection (injectTFYStyles inside IIFE + nav handlers)
    - Dead code removed (fetchAndLogCategory)
  </what-built>
  <resume-signal>Type "approved" if all 5 tests pass, or describe which test failed and what you observed.</resume-signal>
</task>

</tasks>

<verification>
Human confirms all test scenarios pass:
- Test 1: Homepage to watch page activates filtering (SPAV-01)
- Test 2: Related video click activates filtering, no duplicate logs (SPAV-02)
- Test 3: Back/forward navigation activates filtering (SPAV-02)
- Test 4: Shorts shelf visible on homepage, hidden on watch pages (regression check)
- Test 5: Rapid navigation produces single log line per final video (observer hardening)
</verification>

<success_criteria>
1. Filtering activates automatically when navigating from youtube.com to a watch page (no page reload)
2. Filtering activates when clicking a related video in the sidebar (no page reload)
3. Filtering activates on browser back/forward between watch pages
4. Exactly one [TFY] category log line per navigation in the console
5. Shorts shelf is hidden on watch pages but visible on the homepage
</success_criteria>

<output>
After completion, create `.planning/phases/06-spa-navigation-fix/06-02-SUMMARY.md`
</output>
