---
phase: 06-spa-navigation-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - manifest.json
  - content-script.js
autonomous: true
requirements:
  - SPAV-01
  - SPAV-02

must_haves:
  truths:
    - "Manifest content_scripts match pattern covers all YouTube pages, not just watch pages"
    - "disconnectSidebarObserver cancels the retry timer AND disconnects the MutationObserver"
    - "initForVideo calls disconnectSidebarObserver at its first line before any async work"
    - "injectTFYStyles is called only on watch pages (inside IIFE guard and nav handlers), not unconditionally at module top-level"
    - "fetchAndLogCategory function (dead code, lines 215-242) is removed from content-script.js"
  artifacts:
    - path: "manifest.json"
      provides: "Expanded content_scripts match pattern"
      contains: "https://www.youtube.com/*"
    - path: "content-script.js"
      provides: "Timer-aware observer teardown, idempotent initForVideo, watch-page-only CSS injection, dead code removed"
      contains: "sidebarObserverRetryTimer"
  key_links:
    - from: "manifest.json"
      to: "content-script.js"
      via: "content_scripts match pattern — controls which tabs get the content script injected"
      pattern: "youtube\\.com/\\*"
    - from: "disconnectSidebarObserver"
      to: "sidebarObserverRetryTimer"
      via: "clearTimeout call before observer.disconnect"
      pattern: "clearTimeout.*sidebarObserverRetryTimer"
    - from: "initForVideo"
      to: "disconnectSidebarObserver"
      via: "first-line call for idempotency"
      pattern: "async function initForVideo.*\\n\\s+disconnectSidebarObserver"
---

<objective>
Fix the SPA navigation bug: expand the content script match pattern so the content script is present in all YouTube tabs, then harden the observer teardown and init to be idempotent on rapid navigation. Also remove dead code before v1.3 ships.

Purpose: The root cause of SPAV-01 and SPAV-02 is a single manifest misconfiguration — the content script only injects on watch-URL full page loads, so navigating from the YouTube homepage to a video silently drops the YT_NAVIGATION relay message because no content script is present. Expanding the match to `youtube.com/*` fixes this. The observer hardening prevents duplicate observers accumulating on rapid navigation.

Output: Updated manifest.json (one field changed) and updated content-script.js (five targeted changes).
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-spa-navigation-fix/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand manifest match pattern to youtube.com/*</name>
  <files>manifest.json</files>
  <action>
In manifest.json, change the content_scripts match pattern from:

  "matches": ["https://www.youtube.com/watch*"]

to:

  "matches": ["https://www.youtube.com/*"]

This is the single-line root-cause fix for SPAV-01 and SPAV-02. The content script must be present in all YouTube tabs (not just those that performed a full page load on a watch URL) so that the YT_NAVIGATION relay from the service worker reaches the content script when the user starts on youtube.com and clicks a video.

The existing IIFE guard in content-script.js (`const initialVideoId = new URL(window.location.href).searchParams.get('v'); if (initialVideoId && filteringEnabled)`) already correctly handles non-watch injection — when the user lands on the homepage, `initialVideoId` is null and the IIFE does not call `initForVideo`. No other manifest changes are needed.

Do NOT add the "scripting" permission or any programmatic injection — the declarative match pattern is the correct tool here.
  </action>
  <verify>
    <automated>node -e "const m = JSON.parse(require('fs').readFileSync('/home/solanoe/code/tfy/manifest.json','utf8')); const match = m.content_scripts[0].matches[0]; if (match !== 'https://www.youtube.com/*') throw new Error('Wrong match: ' + match); console.log('OK:', match);"</automated>
  </verify>
  <done>manifest.json content_scripts[0].matches[0] is exactly "https://www.youtube.com/*" and no other manifest fields changed.</done>
</task>

<task type="auto">
  <name>Task 2: Harden content-script.js — timer tracking, idempotent init, watch-page CSS guard, dead code removal</name>
  <files>content-script.js</files>
  <action>
Make five targeted changes to content-script.js. Read the file first to confirm exact line numbers before editing.

**Change 1 — Add sidebarObserverRetryTimer module-level variable**

After the existing `let sidebarObserver = null;` line (currently line 61), add:

  let sidebarObserverRetryTimer = null;

This variable stores the handle from observeSidebar's retry setTimeout so it can be cancelled on teardown.

**Change 2 — Store timer handle in observeSidebar**

In the `observeSidebar` function, the retry call is currently:

  setTimeout(() => observeSidebar(callback), 300);

Change it to:

  sidebarObserverRetryTimer = setTimeout(() => observeSidebar(callback), 300);

**Change 3 — Cancel retry timer in disconnectSidebarObserver**

The current `disconnectSidebarObserver` function only disconnects the MutationObserver. Add timer cancellation before the observer disconnect:

  function disconnectSidebarObserver() {
    if (sidebarObserverRetryTimer) {
      clearTimeout(sidebarObserverRetryTimer);
      sidebarObserverRetryTimer = null;
    }
    if (sidebarObserver) {
      sidebarObserver.disconnect();
      sidebarObserver = null;
    }
  }

**Change 4 — Add disconnectSidebarObserver() as the first line of initForVideo**

The current `async function initForVideo(videoId)` begins with the category fetch. Add `disconnectSidebarObserver();` as the very first line of the function body, before any await:

  async function initForVideo(videoId) {
    disconnectSidebarObserver();  // idempotency guard — safe to call even if no observer attached
    // Fetch current video's category
    let response = await chrome.runtime.sendMessage({
      ...

This makes initForVideo idempotent — if called twice for the same video during a rapid navigation race, the second call tears down any observer the first call may have attached.

**Change 5 — Remove unconditional injectTFYStyles() call at module top-level; add it to watch-page-only paths**

Currently, `injectTFYStyles()` is called unconditionally at line 56 (before the IIFE). After expanding the manifest match, the content script injects on the YouTube homepage too. The `ytd-reel-shelf-renderer { display: none }` rule in the injected stylesheet hides Shorts shelves on the homepage, which is out of scope per REQUIREMENTS.md ("Homepage feed filtering — Out of Scope").

Fix:
- Remove the unconditional `injectTFYStyles();` call at module top-level (currently line 56, the line that reads "// Inject styles immediately so they're available before any filtering runs" followed by the call).
- Add `injectTFYStyles();` inside the IIFE, immediately before the `initForVideo(initialVideoId)` call (gated on `initialVideoId && filteringEnabled`).
- Add `injectTFYStyles();` inside the `YT_NAVIGATION` message handler, immediately before the `if (filteringEnabled) initForVideo(message.videoId);` call.
- Add `injectTFYStyles();` inside the `yt-navigate-finish` event listener, immediately before the `if (filteringEnabled) initForVideo(videoId);` call.

The `injectTFYStyles` function already has an idempotency guard (`if (document.getElementById('tfy-styles')) return;`) so calling it multiple times is safe.

**Change 6 — Remove dead code fetchAndLogCategory**

Remove the entire `fetchAndLogCategory` async function (currently lines 215-242, the section under the `// ─── Category Lookup ─────────────────────────────────────────────────────────` comment). This function has zero callers and is superseded by `initForVideo`. Also remove the section comment above it.

The file should have no references to `fetchAndLogCategory` after this change.
  </action>
  <verify>
    <automated>node -e "
const fs = require('fs');
const code = fs.readFileSync('/home/solanoe/code/tfy/content-script.js', 'utf8');
const checks = [
  ['sidebarObserverRetryTimer variable declared', /let sidebarObserverRetryTimer = null/.test(code)],
  ['observeSidebar stores timer handle', /sidebarObserverRetryTimer = setTimeout/.test(code)],
  ['disconnectSidebarObserver clears timer', /clearTimeout\(sidebarObserverRetryTimer\)/.test(code)],
  ['initForVideo starts with disconnectSidebarObserver', /async function initForVideo\(videoId\)\s*\{\s*disconnectSidebarObserver\(\)/.test(code)],
  ['fetchAndLogCategory removed', !/fetchAndLogCategory/.test(code)],
  ['injectTFYStyles not called unconditionally at top level', !/^injectTFYStyles\(\)/m.test(code)],
];
let pass = true;
for (const [name, result] of checks) {
  console.log((result ? 'PASS' : 'FAIL') + ': ' + name);
  if (!result) pass = false;
}
if (!pass) process.exit(1);
console.log('All checks passed');
"</automated>
  </verify>
  <done>
- content-script.js has `let sidebarObserverRetryTimer = null` declared at module level.
- observeSidebar stores its setTimeout handle in sidebarObserverRetryTimer.
- disconnectSidebarObserver clears sidebarObserverRetryTimer before disconnecting the observer.
- initForVideo calls disconnectSidebarObserver() as its first line.
- fetchAndLogCategory function is fully removed (no references remain).
- injectTFYStyles is not called unconditionally at module top-level; it is called inside the IIFE and inside both nav handlers when initializing for a video.
  </done>
</task>

</tasks>

<verification>
Run both verify commands from the tasks above. Both must exit 0.

Also confirm no syntax errors in content-script.js:
  node --check /home/solanoe/code/tfy/content-script.js

And confirm manifest.json is valid JSON:
  node -e "JSON.parse(require('fs').readFileSync('/home/solanoe/code/tfy/manifest.json','utf8')); console.log('valid JSON')"
</verification>

<success_criteria>
1. manifest.json content_scripts[0].matches[0] is "https://www.youtube.com/*"
2. content-script.js passes node --check (no syntax errors)
3. sidebarObserverRetryTimer is declared, stored, and cleared in disconnect
4. initForVideo starts with disconnectSidebarObserver()
5. fetchAndLogCategory is fully removed
6. injectTFYStyles is not called unconditionally at module top-level
</success_criteria>

<output>
After completion, create `.planning/phases/06-spa-navigation-fix/06-01-SUMMARY.md`
</output>
