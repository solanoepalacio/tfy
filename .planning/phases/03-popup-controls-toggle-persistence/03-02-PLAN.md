---
phase: 03-popup-controls-toggle-persistence
plan: 02
type: execute
wave: 2
depends_on:
  - 03-01
files_modified: []
autonomous: false
requirements:
  - POPU-01
  - CORE-04

must_haves:
  truths:
    - "User can disable filtering from popup and sidebar items immediately become fully visible"
    - "User can re-enable filtering from popup and off-topic sidebar items collapse again without page reload"
    - "Toggle state persists across browser restart — disabled remains disabled after Chrome is closed and reopened"
  artifacts:
    - path: "popup.html"
      provides: "Visible toggle checkbox in popup UI"
      contains: "toggle-filtering"
    - path: "popup.js"
      provides: "Toggle state read/write and content script notification"
      contains: "TFY_TOGGLE"
    - path: "content-script.js"
      provides: "Startup guard and live toggle handler"
      contains: "filteringEnabled"
  key_links:
    - from: "popup.js toggle change handler"
      to: "content-script.js TFY_TOGGLE handler"
      via: "chrome.tabs.sendMessage on active YouTube watch tab"
      pattern: "tabs\\.sendMessage.*TFY_TOGGLE"
    - from: "chrome.storage.local filteringEnabled"
      to: "content-script.js startup IIFE"
      via: "chrome.storage.local.get on page load"
      pattern: "storage\\.local\\.get.*filteringEnabled"
---

<objective>
Human verification of the complete popup toggle + persistence feature.

Purpose: Confirms the end-to-end toggle flow works as intended in a real Chrome browser — the only environment where chrome APIs, popup messaging, and content script interaction can be fully tested.

Output: Verified Phase 3 feature. Phase 3 complete.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/03-popup-controls-toggle-persistence/03-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Verify toggle feature end-to-end in Chrome</name>
  <action>Human verifies the complete toggle pipeline works in a real Chrome browser. No automated action — this checkpoint follows Plan 01 which built all the code. Reload the extension before testing.</action>
  <what-built>
    Popup toggle checkbox (Enable filtering) wired to chrome.storage.local with real-time notification to the content script via chrome.tabs.sendMessage. Content script reads stored toggle state at startup and handles live TFY_TOGGLE messages by disconnecting the MutationObserver and resetting collapsed CSS classes.
  </what-built>
  <how-to-verify>
    Reload the extension first:
    1. Open chrome://extensions
    2. Find "TFY — Topic Focused YouTube" and click the reload icon (circular arrow)

    Test A — Toggle OFF (immediate effect):
    3. Navigate to any YouTube watch page (e.g. https://www.youtube.com/watch?v=dQw4w9WgXcQ)
    4. Wait for sidebar filtering to run — off-topic sidebar items should be visually collapsed with "hidden: off-topic" label
    5. Click the TFY extension icon to open the popup
    6. Confirm the "Enable filtering" checkbox is checked
    7. Uncheck the "Enable filtering" checkbox
    8. Switch back to the YouTube tab — sidebar items should immediately become fully visible (no collapsed items)
    9. Open DevTools Console — confirm no errors; confirm no new [TFY] filter logs appear as you scroll

    Test B — Toggle ON (immediate re-filter):
    10. With the popup still accessible, check the "Enable filtering" checkbox again
    11. Switch back to the YouTube tab — off-topic sidebar items should collapse again within ~1 second
    12. Confirm [TFY] Sidebar filter: collapsed N of M log appears in DevTools Console

    Test C — Persistence across browser restart:
    13. Open the popup, uncheck "Enable filtering", close the popup
    14. Close Chrome completely (File > Quit, or close all windows)
    15. Reopen Chrome and navigate to a YouTube watch page
    16. Open the extension popup — confirm the "Enable filtering" checkbox is still unchecked
    17. Confirm the sidebar is NOT filtered (all items visible, no "hidden: off-topic" labels)
    18. Re-enable filtering in the popup before closing this verify step

    Test D — Fresh install default (optional):
    19. (Optional) Open chrome://extensions, remove the extension, re-add it via "Load unpacked"
    20. Navigate to a YouTube watch page — filtering should be ON by default without any popup interaction
  </how-to-verify>
  <verify>Human-only verification — no automated command available for live browser testing.</verify>
  <done>Tests A, B, and C all pass: toggle OFF reveals sidebar immediately, toggle ON re-collapses within ~1 second, toggle state survives Chrome restart. No JavaScript errors in DevTools.</done>
  <resume-signal>Type "approved" if all three required tests (A, B, C) pass. Describe any failures with which test step failed and what you observed instead.</resume-signal>
</task>

</tasks>

<verification>
This plan IS the verification step. The checkpoint task is the sole deliverable.
</verification>

<success_criteria>
- Test A passes: toggling OFF immediately reveals all sidebar items on the current watch page
- Test B passes: toggling ON immediately re-collapses off-topic items (within ~1 second)
- Test C passes: toggle state survives Chrome restart — disabled remains disabled on next launch
- No JavaScript errors in DevTools during any test step
</success_criteria>

<output>
After completion, create `.planning/phases/03-popup-controls-toggle-persistence/03-02-SUMMARY.md`
</output>
