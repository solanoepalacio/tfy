---
phase: 01-extension-foundation-category-detection
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - manifest.json
  - popup.html
  - popup.js
  - icons/icon16.png
  - icons/icon48.png
  - icons/icon128.png
autonomous: true
requirements:
  - CORE-01
  - CORE-02

must_haves:
  truths:
    - "Extension loads in Chrome developer mode without errors"
    - "Popup opens when extension icon is clicked and shows an API key input field"
    - "API key entered in popup is saved and visible when popup is reopened"
    - "API key persists after browser restart (chrome.storage.local)"
  artifacts:
    - path: "manifest.json"
      provides: "MV3 extension manifest declaring service worker, content script, popup, permissions"
      contains: "manifest_version.*3"
    - path: "popup.html"
      provides: "HTML UI for API key input"
      contains: "api-key-input"
    - path: "popup.js"
      provides: "Read/write API key to chrome.storage.local"
      exports: []
    - path: "icons/icon16.png"
      provides: "Extension icon 16px"
    - path: "icons/icon48.png"
      provides: "Extension icon 48px"
    - path: "icons/icon128.png"
      provides: "Extension icon 128px"
  key_links:
    - from: "manifest.json"
      to: "popup.html"
      via: "action.default_popup"
      pattern: "default_popup.*popup\\.html"
    - from: "popup.js"
      to: "chrome.storage.local"
      via: "chrome.storage.local.set({ apiKey })"
      pattern: "storage\\.local\\.set"
    - from: "popup.html"
      to: "popup.js"
      via: "<script src>"
      pattern: "popup\\.js"
---

<objective>
Create the Chrome MV3 extension scaffold: manifest.json declaring all required permissions and entry points, placeholder icons, and a popup that allows the user to enter and persist their YouTube Data API key.

Purpose: This is the foundation every other phase builds on. The manifest wires together the service worker, content script, and popup. The API key popup (CORE-02) is the only user-facing UI needed in Phase 1 and is self-contained alongside the manifest.
Output: A loadable Chrome extension directory at the repo root. Loading it unpacked in Chrome should show the extension icon and open a working API-key popup.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-extension-foundation-category-detection/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create manifest.json and extension icons</name>
  <files>manifest.json, icons/icon16.png, icons/icon48.png, icons/icon128.png</files>
  <action>
Create `manifest.json` at the repo root with the following exact structure (verified pattern from RESEARCH.md):

```json
{
  "manifest_version": 3,
  "name": "TFY — Topic Focused YouTube",
  "version": "0.1.0",
  "description": "Filters YouTube sidebar suggestions to stay on-topic",
  "permissions": ["storage", "webNavigation"],
  "host_permissions": [
    "https://www.googleapis.com/*",
    "https://www.youtube.com/*"
  ],
  "background": {
    "service_worker": "service-worker.js"
  },
  "content_scripts": [
    {
      "matches": ["https://www.youtube.com/watch*"],
      "js": ["content-script.js"],
      "run_at": "document_idle"
    }
  ],
  "action": {
    "default_popup": "popup.html",
    "default_icon": {
      "16": "icons/icon16.png",
      "48": "icons/icon48.png",
      "128": "icons/icon128.png"
    }
  }
}
```

Key requirements:
- `manifest_version: 3` — required for current Chrome
- `permissions`: `storage` (for chrome.storage.local API key storage) and `webNavigation` (for SPA navigation detection in service worker)
- `host_permissions`: both googleapis.com (service worker fetch) and youtube.com (content script injection)
- `content_scripts.matches`: MUST be `"https://www.youtube.com/watch*"` — NOT `"https://www.youtube.com/*"` (too broad; would inject on homepage/search)
- `run_at: "document_idle"` — ensures URL reflects current video before content script reads it

Create `icons/` directory and generate three simple placeholder PNG icons (16x16, 48x48, 128x128). Use a solid colored square (e.g., blue #1a73e8) — these are developer-mode placeholders. Generate them using Node.js with the `canvas` npm package IF available, otherwise create minimal valid PNG files using raw bytes. A minimal 1x1 PNG scaled via the browser is acceptable for developer mode — the icon does not need to be high quality, it just needs to be a valid PNG file that Chrome accepts.

Simplest approach if no canvas available: write a Node.js script inline that generates a minimal valid PNG binary (PNG header + IHDR + IDAT + IEND chunks) for each size, then run it. Alternatively, use ImageMagick if available (`convert -size 16x16 xc:#1a73e8 icons/icon16.png`).

Check what's available: `which convert` or `which node`. Use whichever works. The icons just need to be valid PNG files Chrome won't reject.
  </action>
  <verify>
    <automated>node -e "const m = JSON.parse(require('fs').readFileSync('/home/solanoe/code/tfy/manifest.json','utf8')); console.assert(m.manifest_version===3); console.assert(m.permissions.includes('storage')); console.assert(m.permissions.includes('webNavigation')); console.assert(m.content_scripts[0].matches[0]==='https://www.youtube.com/watch*'); console.log('manifest.json OK'); require('fs').statSync('/home/solanoe/code/tfy/icons/icon16.png'); require('fs').statSync('/home/solanoe/code/tfy/icons/icon48.png'); require('fs').statSync('/home/solanoe/code/tfy/icons/icon128.png'); console.log('icons OK');"</automated>
    <manual>Load the extension at chrome://extensions (developer mode, Load unpacked → select repo root). Extension should appear without errors in the extensions list.</manual>
  </verify>
  <done>manifest.json exists with manifest_version 3, correct permissions, and watch-only content script match. Three icon PNG files exist in icons/.</done>
</task>

<task type="auto">
  <name>Task 2: Create popup.html and popup.js for API key storage</name>
  <files>popup.html, popup.js</files>
  <action>
Create `popup.html` — minimal HTML page for API key entry:

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>TFY Settings</title>
  <style>
    body { font-family: sans-serif; padding: 12px; width: 280px; }
    h2 { font-size: 14px; margin: 0 0 10px; }
    label { font-size: 12px; display: block; margin-bottom: 4px; color: #555; }
    input { width: 100%; box-sizing: border-box; padding: 6px; font-size: 12px; border: 1px solid #ccc; border-radius: 4px; }
    button { margin-top: 8px; padding: 6px 12px; font-size: 12px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; }
    button:hover { background: #1557b0; }
    #status { font-size: 11px; color: #1a73e8; margin-top: 6px; min-height: 16px; }
  </style>
</head>
<body>
  <h2>TFY — Topic Focused YouTube</h2>
  <label for="api-key-input">YouTube Data API v3 Key</label>
  <input type="password" id="api-key-input" placeholder="AIza...">
  <button id="save-btn">Save</button>
  <div id="status"></div>
  <script src="popup.js"></script>
</body>
</html>
```

Create `popup.js` — reads/writes API key via chrome.storage.local:

```javascript
// popup.js — API key management
// Uses chrome.storage.local (not localStorage — localStorage in content scripts
// writes to youtube.com's storage domain, not the extension's)

document.addEventListener('DOMContentLoaded', async () => {
  const { apiKey } = await chrome.storage.local.get('apiKey');
  if (apiKey) {
    document.getElementById('api-key-input').value = apiKey;
    document.getElementById('status').textContent = 'API key loaded.';
  }
});

document.getElementById('save-btn').addEventListener('click', async () => {
  const key = document.getElementById('api-key-input').value.trim();
  if (!key) {
    document.getElementById('status').textContent = 'Please enter an API key.';
    return;
  }
  await chrome.storage.local.set({ apiKey: key });
  document.getElementById('status').textContent = 'Saved.';
});
```

Important implementation notes:
- Use `type="password"` on the input so the API key is masked (basic UX, not security)
- Load existing key on DOMContentLoaded so reopening popup shows the saved key
- Trim whitespace from input before saving (prevents accidental space-padded keys)
- `chrome.storage.local.get('apiKey')` returns `{}` if unset — destructure safely with `const { apiKey } = ...`
  </action>
  <verify>
    <automated>node -e "const fs = require('fs'); const html = fs.readFileSync('/home/solanoe/code/tfy/popup.html','utf8'); console.assert(html.includes('id=\"api-key-input\"'), 'missing input'); console.assert(html.includes('id=\"save-btn\"'), 'missing button'); console.assert(html.includes('popup.js'), 'missing script'); const js = fs.readFileSync('/home/solanoe/code/tfy/popup.js','utf8'); console.assert(js.includes('storage.local.set'), 'missing storage.set'); console.assert(js.includes('storage.local.get'), 'missing storage.get'); console.assert(js.includes('DOMContentLoaded'), 'missing DOMContentLoaded'); console.log('popup files OK');"</automated>
    <manual>After loading extension in Chrome, click the extension icon. Popup opens showing "TFY — Topic Focused YouTube" heading, an API key input field, and a Save button. Enter a test key, click Save — status shows "Saved." Close popup, reopen it — key is still populated.</manual>
  </verify>
  <done>popup.html and popup.js exist. popup.html references api-key-input, save-btn, status elements. popup.js uses chrome.storage.local.get on DOMContentLoaded and chrome.storage.local.set on save. API key survives popup close/reopen.</done>
</task>

</tasks>

<verification>
Run both automated verify commands. Both must pass with no assertion errors.

Cross-check: grep manifest.json for `"https://www.youtube.com/watch*"` (not `/*`). grep popup.js for `chrome.storage.local` (not `localStorage`).
</verification>

<success_criteria>
1. manifest.json exists with manifest_version 3, permissions [storage, webNavigation], content_scripts matching only youtube.com/watch*, service_worker declared
2. icons/icon16.png, icons/icon48.png, icons/icon128.png exist as valid PNG files
3. popup.html has api-key-input, save-btn, status elements and includes popup.js
4. popup.js reads API key on DOMContentLoaded and writes on save-btn click using chrome.storage.local
5. Extension loads in Chrome developer mode without errors in chrome://extensions
</success_criteria>

<output>
After completion, create `.planning/phases/01-extension-foundation-category-detection/01-01-SUMMARY.md`
</output>
