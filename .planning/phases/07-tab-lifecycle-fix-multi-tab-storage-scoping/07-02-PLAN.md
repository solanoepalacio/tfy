---
phase: 07-tab-lifecycle-fix-multi-tab-storage-scoping
plan: 02
type: execute
wave: 2
depends_on:
  - "07-01"
files_modified: []
autonomous: false
requirements:
  - TABST-01
  - TABST-02
  - TABST-03

must_haves:
  truths:
    - "Popup shows no category after closing a YouTube watch tab (TABST-01)"
    - "Popup shows the correct category for the active YouTube tab when two tabs have different videos (TABST-02)"
    - "Closing a non-YouTube tab leaves the popup's YouTube category display intact (TABST-03)"
  artifacts: []
  key_links: []
---

<objective>
Human verification of the tab lifecycle and multi-tab storage scoping fix in a real Chrome browser. Claude cannot test chrome.tabs.onRemoved, multi-tab storage state, or popup rendering without a live browser session. This checkpoint verifies all three TABST requirements.

Purpose: Chrome extension tab lifecycle behavior is only verifiable in an actual Chrome browser with the extension loaded in developer mode.

Output: Human confirmation that TABST-01, TABST-02, and TABST-03 pass in live Chrome.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tab-lifecycle-fix-multi-tab-storage-scoping/07-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Human verification: TABST-01, TABST-02, TABST-03 in live Chrome browser</name>
  <action>
    Run the four test scenarios below in Chrome with TFY loaded in developer mode. Report results for each test. No automated tests exist for multi-tab chrome.tabs.onRemoved behavior — live browser is the only valid environment.
  </action>
  <verify>
    <automated>MISSING — Chrome extension tab lifecycle tests require a live browser session; automated verification is not possible for this task.</automated>
    <manual>See how-to-verify section below for the four test scenarios.</manual>
  </verify>
  <done>Human confirms all four test scenarios pass and types "approved".</done>
  <what-built>
    Per-tab storage scoping fix across manifest.json, service-worker.js, content-script.js, and popup.js:
    - chrome.tabs.onRemoved deletes the tab's currentVideoCategory_${tabId} key on close
    - content-script.js delegates category storage writes to service-worker via SET_VIDEO_CATEGORY / CLEAR_VIDEO_CATEGORY messages
    - popup.js reads currentVideoCategory_${tab.id} for the currently active tab at open time
    - "tabs" permission added to manifest.json
  </what-built>
  <how-to-verify>
    **Setup:** Open Chrome with TFY loaded in developer mode (chrome://extensions → Load unpacked). Open the DevTools Service Worker console from the extension page to observe any errors.

    **Test 1 — TABST-01: Tab close clears popup**
    1. Open a YouTube watch page (e.g., any video at youtube.com/watch?v=...)
    2. Wait for the page to load and TFY to filter the sidebar (console shows "[TFY] Current video category: ...")
    3. Open the TFY popup — confirm it shows "Watching: {CategoryName}"
    4. Close that YouTube tab
    5. Open the TFY popup again (from any other tab or the extensions toolbar)
    EXPECTED: The popup shows no category text (neutral/blank state — just the API key and toggle)

    **Test 2 — TABST-02: Multi-tab shows correct active tab's category**
    1. Open two YouTube watch page tabs with different videos from different categories (e.g., a Music video and a Science & Technology video)
    2. Wait for TFY to filter both sidebars (check each tab's console)
    3. Click on Tab 1 (e.g., the Music tab) to make it active
    4. Open the TFY popup
    EXPECTED: Popup shows "Watching: Music" (or whatever category Tab 1's video is)
    5. Click on Tab 2 (e.g., Science & Technology) to make it active
    6. Open the TFY popup again
    EXPECTED: Popup shows "Watching: Science & Technology" (Tab 2's category)

    **Test 3 — TABST-03: Non-YouTube tab close has no effect**
    1. With a YouTube watch tab open and TFY showing its category in the popup:
    2. Open a non-YouTube tab (gmail.com, google.com, any non-YouTube page)
    3. Close that non-YouTube tab
    4. Switch back to the YouTube watch tab
    5. Open the TFY popup
    EXPECTED: Popup still shows the YouTube tab's category unchanged

    **Regression check — Filtering still works after the change**
    1. On a YouTube watch page, confirm the sidebar still filters (off-topic videos are collapsed with labels)
    2. Navigate to a different YouTube video via related video click
    EXPECTED: Filtering re-runs for the new video; popup updates to new video's category when opened
  </how-to-verify>
  <resume-signal>Type "approved" if all 4 tests pass, or describe which test failed and what you observed.</resume-signal>
</task>

</tasks>

<verification>
Human verification is the final gate. All TABST requirements are satisfied when the checkpoint is approved.
</verification>

<success_criteria>
- TABST-01: Popup shows neutral state after closing a YouTube watch tab
- TABST-02: Popup shows active tab's category when multiple YouTube tabs are open
- TABST-03: Closing a non-YouTube tab has no effect on YouTube tab popup state
- Regression: Sidebar filtering continues to work correctly on watch page navigation
- Human types "approved" to complete the checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/07-tab-lifecycle-fix-multi-tab-storage-scoping/07-02-SUMMARY.md` documenting:
- Which test scenarios passed
- Any unexpected behavior observed
- Phase 7 completion status
</output>
