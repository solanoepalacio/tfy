---
phase: 07-tab-lifecycle-fix-multi-tab-storage-scoping
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - manifest.json
  - service-worker.js
  - content-script.js
  - popup.js
autonomous: true
requirements:
  - TABST-01
  - TABST-02
  - TABST-03

must_haves:
  truths:
    - "Popup shows neutral state (no category text) when the last YouTube watch tab has been closed"
    - "Popup shows the category of whichever YouTube watch tab is currently active when multiple tabs are open"
    - "Closing a non-YouTube tab (Gmail, etc.) has no effect on the category stored for open YouTube watch tabs"
    - "Per-tab storage key currentVideoCategory_${tabId} is written on video load and deleted on tab close"
  artifacts:
    - path: "manifest.json"
      provides: "tabs permission enabling chrome.tabs.onRemoved"
      contains: '"tabs"'
    - path: "service-worker.js"
      provides: "onRemoved cleanup + SET_VIDEO_CATEGORY + CLEAR_VIDEO_CATEGORY handlers"
      exports: []
    - path: "content-script.js"
      provides: "Delegates category storage writes to service worker; no direct chrome.storage.local category writes remain"
    - path: "popup.js"
      provides: "Reads currentVideoCategory_${tabId} for the active tab at popup open time"
  key_links:
    - from: "content-script.js"
      to: "service-worker.js"
      via: "chrome.runtime.sendMessage({ type: 'SET_VIDEO_CATEGORY' })"
      pattern: "SET_VIDEO_CATEGORY"
    - from: "service-worker.js"
      to: "chrome.storage.local"
      via: "chrome.storage.local.set({ [`currentVideoCategory_${sender.tab.id}`]: ... })"
      pattern: "currentVideoCategory_\\$\\{sender\\.tab\\.id\\}"
    - from: "chrome.tabs.onRemoved"
      to: "chrome.storage.local"
      via: "chrome.storage.local.remove(`currentVideoCategory_${tabId}`)"
      pattern: "onRemoved"
    - from: "popup.js"
      to: "chrome.storage.local"
      via: "chrome.tabs.query + chrome.storage.local.get(`currentVideoCategory_${tab.id}`)"
      pattern: "currentVideoCategory_\\$\\{tab\\.id\\}"
---

<objective>
Migrate chrome.storage.local category storage from a single shared key (currentVideoCategory) to a per-tab scoped key (currentVideoCategory_${tabId}). Register chrome.tabs.onRemoved to delete each tab's key on close. Update the popup to read the active tab's scoped key. Add the "tabs" permission to the manifest.

Purpose: Fix three runtime correctness bugs — stale popup category after tab close (TABST-01), wrong category when multiple YouTube tabs open (TABST-02), and non-YouTube tab closes affecting YouTube state (TABST-03). All three root-cause to the single shared storage key.

Output: Four modified files (manifest.json, service-worker.js, content-script.js, popup.js) with no remaining references to the unscoped currentVideoCategory key.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tab-lifecycle-fix-multi-tab-storage-scoping/07-RESEARCH.md
@manifest.json
@service-worker.js
@content-script.js
@popup.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tabs permission + register onRemoved + add SET/CLEAR_VIDEO_CATEGORY handlers in service-worker.js</name>
  <files>manifest.json, service-worker.js</files>
  <action>
**manifest.json:** Add `"tabs"` to the `permissions` array alongside existing `"storage"`, `"webNavigation"`, `"activeTab"`. The `"tabs"` permission is required for `chrome.tabs.onRemoved` to fire — `"activeTab"` alone is insufficient (it grants only temporary per-invocation access). Result: `"permissions": ["storage", "webNavigation", "activeTab", "tabs"]`.

**service-worker.js — two changes:**

1. In the existing `chrome.runtime.onMessage.addListener` handler, add two new message type branches AFTER the existing `GET_VIDEO_CATEGORY` branch:

```javascript
if (message.type === 'SET_VIDEO_CATEGORY') {
  // sender.tab.id is authoritative — set per-tab scoped key
  chrome.storage.local.set({
    [`currentVideoCategory_${sender.tab.id}`]: message.categoryName
  });
  return; // no async response needed
}
if (message.type === 'CLEAR_VIDEO_CATEGORY') {
  chrome.storage.local.remove(`currentVideoCategory_${sender.tab.id}`);
  return;
}
```

2. At TOP-LEVEL (not inside any function or async block — MV3 service worker requirement), after the existing `chrome.webNavigation.onHistoryStateUpdated.addListener` block, register:

```javascript
// ─── Tab Lifecycle Cleanup ────────────────────────────────────────────────
// TABST-01: Delete per-tab scoped storage key when any tab closes.
// Must be top-level — service worker re-registers listeners from top-level
// synchronous code only. Listeners inside async functions are lost on restart.
// isWindowClosing flag intentionally NOT checked — cleanup always runs
// (each tab in a closing window fires onRemoved individually anyway).
chrome.tabs.onRemoved.addListener((tabId) => {
  chrome.storage.local.remove(`currentVideoCategory_${tabId}`);
});
```

Also add a one-time startup cleanup to remove any stale unscoped key from previous TFY versions. Add this line at the end of the existing `chrome.runtime.onMessage.addListener` call (after the `});` closing) — at top level:

```javascript
// One-time migration: remove stale unscoped key from pre-Phase-7 versions.
// No-op if key does not exist.
chrome.storage.local.remove('currentVideoCategory');
```
  </action>
  <verify>
    <automated>grep -n '"tabs"' /home/solanoe/code/tfy/manifest.json && grep -n 'onRemoved' /home/solanoe/code/tfy/service-worker.js && grep -n 'SET_VIDEO_CATEGORY' /home/solanoe/code/tfy/service-worker.js && grep -n 'CLEAR_VIDEO_CATEGORY' /home/solanoe/code/tfy/service-worker.js</automated>
    <manual>Confirm "tabs" appears in permissions array in manifest.json; onRemoved listener is at top level (not nested inside a function); SET_VIDEO_CATEGORY and CLEAR_VIDEO_CATEGORY branches exist in the onMessage handler.</manual>
  </verify>
  <done>"tabs" in manifest.json permissions; chrome.tabs.onRemoved.addListener at top level in service-worker.js; SET_VIDEO_CATEGORY and CLEAR_VIDEO_CATEGORY handled in onMessage; stale key removal at top level.</done>
</task>

<task type="auto">
  <name>Task 2: Replace direct storage writes in content-script.js with service-worker delegate messages</name>
  <files>content-script.js</files>
  <action>
Remove ALL direct `chrome.storage.local` writes and removes for `currentVideoCategory` from content-script.js. Delegate to service worker via sendMessage instead.

**Change 1 — inside `initForVideo()` (around line 204):**

Replace:
```javascript
chrome.storage.local.set({ currentVideoCategory: currentCategoryName });
```

With:
```javascript
// Delegate storage write to service worker — it has sender.tab.id, content scripts do not
chrome.runtime.sendMessage({
  type: 'SET_VIDEO_CATEGORY',
  categoryName: currentCategoryName
}).catch(() => {}); // Non-fatal — popup shows blank if this fails
```

**Change 2 — inside the `YT_NAVIGATION` message handler (around line 261):**

Replace:
```javascript
chrome.storage.local.remove('currentVideoCategory');
```

With:
```javascript
chrome.runtime.sendMessage({ type: 'CLEAR_VIDEO_CATEGORY' }).catch(() => {});
```

**Verify completeness:** After both changes, there must be ZERO remaining references to `currentVideoCategory` (either the old unscoped key string) in content-script.js. Run a search to confirm.

Do NOT change any other logic — teardown order, observer handling, IIFE, fallback handler — remains identical. Only the two storage operation lines change.
  </action>
  <verify>
    <automated>grep -n 'currentVideoCategory' /home/solanoe/code/tfy/content-script.js | grep -v 'SET_VIDEO_CATEGORY\|CLEAR_VIDEO_CATEGORY' || echo "CLEAN — no unscoped references remain"</automated>
    <manual>Confirm no direct chrome.storage.local.set or .remove calls referencing currentVideoCategory remain. Both SET_VIDEO_CATEGORY and CLEAR_VIDEO_CATEGORY sendMessage calls are present with .catch(() => {}) guards.</manual>
  </verify>
  <done>Zero references to the unscoped `currentVideoCategory` string in content-script.js. Both storage operations delegated to service worker via sendMessage with catch guards.</done>
</task>

<task type="auto">
  <name>Task 3: Update popup.js to read per-tab scoped category key for the active tab</name>
  <files>popup.js</files>
  <action>
Replace the global `currentVideoCategory` read in the `DOMContentLoaded` handler with a scoped per-tab read using the active tab's ID.

In the `DOMContentLoaded` handler, replace:
```javascript
const { currentVideoCategory } = await chrome.storage.local.get('currentVideoCategory');
if (currentVideoCategory) {
  document.getElementById('current-category').textContent = `Watching: ${currentVideoCategory}`;
}
```

With:
```javascript
// TABST-01/02/03: Read per-tab scoped key for the active tab at popup open time.
// If the active tab is not a YouTube watch page, or the tab has no stored category,
// the element is left blank (neutral state).
const [tab] = await chrome.tabs.query({ active: true, currentWindow: true });
if (tab?.url?.includes('youtube.com/watch')) {
  const key = `currentVideoCategory_${tab.id}`;
  const result = await chrome.storage.local.get(key);
  const category = result[key];
  if (category) {
    document.getElementById('current-category').textContent = `Watching: ${category}`;
  }
}
// else: not a YouTube watch page — neutral state (blank) is correct for TABST-03
```

The `chrome.tabs.query` call at the top of this file already uses this pattern in the `toggle-filtering` change handler — follow the same pattern. No new APIs or permissions are needed (popup has access to `chrome.tabs.query` by default for its own window).

After the change, there must be ZERO remaining references to `currentVideoCategory` (unscoped) in popup.js.
  </action>
  <verify>
    <automated>grep -n 'currentVideoCategory' /home/solanoe/code/tfy/popup.js | grep -v 'currentVideoCategory_' || echo "CLEAN — no unscoped references remain"</automated>
    <manual>Confirm popup.js reads currentVideoCategory_${tab.id} inside a tab?.url?.includes('youtube.com/watch') guard. No unscoped currentVideoCategory references remain.</manual>
  </verify>
  <done>popup.js reads currentVideoCategory_${tab.id} for the active tab. Guarded by youtube.com/watch URL check. Zero unscoped currentVideoCategory references remain in popup.js.</done>
</task>

</tasks>

<verification>
After all three tasks complete, run the following cross-file completeness checks:

1. **No unscoped key remains anywhere:**
   ```
   grep -rn 'currentVideoCategory[^_]' /home/solanoe/code/tfy/content-script.js /home/solanoe/code/tfy/popup.js /home/solanoe/code/tfy/service-worker.js
   ```
   Expected: zero matches (the unscoped key is completely replaced).

2. **tabs permission present:**
   ```
   grep '"tabs"' /home/solanoe/code/tfy/manifest.json
   ```
   Expected: one match inside the permissions array.

3. **onRemoved at top level (not nested):**
   ```
   grep -n 'onRemoved' /home/solanoe/code/tfy/service-worker.js
   ```
   Expected: the listener registration is at column 0 indentation (top level).

4. **Content script uses delegate messages:**
   ```
   grep -n 'SET_VIDEO_CATEGORY\|CLEAR_VIDEO_CATEGORY' /home/solanoe/code/tfy/content-script.js
   ```
   Expected: two matches — one SET in initForVideo, one CLEAR in YT_NAVIGATION handler.
</verification>

<success_criteria>
- manifest.json: `"tabs"` in permissions array
- service-worker.js: `chrome.tabs.onRemoved.addListener` registered at top level; `SET_VIDEO_CATEGORY` and `CLEAR_VIDEO_CATEGORY` handled in `onMessage`; stale `currentVideoCategory` key removed at startup
- content-script.js: zero direct `chrome.storage.local` writes/removes for `currentVideoCategory`; both storage operations delegated via `sendMessage`
- popup.js: reads `currentVideoCategory_${tab.id}` guarded by `youtube.com/watch` URL check; zero references to unscoped key
- All four files: grep for unscoped `currentVideoCategory` (not followed by `_`) returns zero matches
</success_criteria>

<output>
After completion, create `.planning/phases/07-tab-lifecycle-fix-multi-tab-storage-scoping/07-01-SUMMARY.md` documenting:
- What changed in each file
- The storage key migration (currentVideoCategory → currentVideoCategory_${tabId})
- Pitfalls avoided (top-level onRemoved registration, tabs permission, delegate pattern rationale)
- Any deviations from the plan
</output>
